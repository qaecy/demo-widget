import{Da as ie,N as K,ea as X,ja as ee,ka as te,l as F,sa as re,v as $}from"./chunk-YQ7LY5XH.js";import{C as D,Ca as S,W as oe,Y as ne,t as y,v as h,wa as I,za as se}from"./chunk-3CERLCYU.js";import{O as _}from"./chunk-6QX3GPPT.js";import{Q as u,U as g,Va as p,ec as x,fc as Z,hc as N}from"./chunk-Q5IV2UU5.js";import{a as m}from"./chunk-DAQOROHW.js";var ae=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function me(r){return typeof r=="string"&&ae.test(r)}var ce=me;function _e(r){if(!ce(r))throw TypeError("Invalid UUID");let e;return Uint8Array.of((e=parseInt(r.slice(0,8),16))>>>24,e>>>16&255,e>>>8&255,e&255,(e=parseInt(r.slice(9,13),16))>>>8,e&255,(e=parseInt(r.slice(14,18),16))>>>8,e&255,(e=parseInt(r.slice(19,23),16))>>>8,e&255,(e=parseInt(r.slice(24,36),16))/1099511627776&255,e/4294967296&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255)}var H=_e;var d=[];for(let r=0;r<256;++r)d.push((r+256).toString(16).slice(1));function E(r,e=0){return(d[r[e+0]]+d[r[e+1]]+d[r[e+2]]+d[r[e+3]]+"-"+d[r[e+4]]+d[r[e+5]]+"-"+d[r[e+6]]+d[r[e+7]]+"-"+d[r[e+8]]+d[r[e+9]]+"-"+d[r[e+10]]+d[r[e+11]]+d[r[e+12]]+d[r[e+13]]+d[r[e+14]]+d[r[e+15]]).toLowerCase()}var M,Ie=new Uint8Array(16);function Y(){if(!M){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");M=crypto.getRandomValues.bind(crypto)}return M(Ie)}function Se(r){r=unescape(encodeURIComponent(r));let e=new Uint8Array(r.length);for(let t=0;t<r.length;++t)e[t]=r.charCodeAt(t);return e}var fe="6ba7b810-9dad-11d1-80b4-00c04fd430c8",de="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function W(r,e,t,i,o,n){let a=typeof t=="string"?Se(t):t,l=typeof i=="string"?H(i):i;if(typeof i=="string"&&(i=H(i)),i?.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let s=new Uint8Array(16+a.length);if(s.set(l),s.set(a,l.length),s=e(s),s[6]=s[6]&15|r,s[8]=s[8]&63|128,o){n=n||0;for(let c=0;c<16;++c)o[n+c]=s[c];return o}return E(s)}var ve=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),G={randomUUID:ve};function xe(r,e,t){if(G.randomUUID&&!e&&!r)return G.randomUUID();r=r||{};let i=r.random||(r.rng||Y)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let o=0;o<16;++o)e[t+o]=i[o];return e}return E(i)}var U=xe;function ye(r,e,t,i){switch(r){case 0:return e&t^~e&i;case 1:return e^t^i;case 2:return e&t^e&i^t&i;case 3:return e^t^i}}function Q(r,e){return r<<e|r>>>32-e}function De(r){let e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520],i=new Uint8Array(r.length+1);i.set(r),i[r.length]=128,r=i;let o=r.length/4+2,n=Math.ceil(o/16),a=new Array(n);for(let l=0;l<n;++l){let s=new Uint32Array(16);for(let c=0;c<16;++c)s[c]=r[l*64+c*4]<<24|r[l*64+c*4+1]<<16|r[l*64+c*4+2]<<8|r[l*64+c*4+3];a[l]=s}a[n-1][14]=(r.length-1)*8/Math.pow(2,32),a[n-1][14]=Math.floor(a[n-1][14]),a[n-1][15]=(r.length-1)*8&4294967295;for(let l=0;l<n;++l){let s=new Uint32Array(80);for(let f=0;f<16;++f)s[f]=a[l][f];for(let f=16;f<80;++f)s[f]=Q(s[f-3]^s[f-8]^s[f-14]^s[f-16],1);let c=t[0],j=t[1],A=t[2],P=t[3],k=t[4];for(let f=0;f<80;++f){let J=Math.floor(f/20),he=Q(c,5)+ye(J,j,A,P)+k+e[J]+s[f]>>>0;k=P,P=A,A=Q(j,30)>>>0,j=c,c=he}t[0]=t[0]+c>>>0,t[1]=t[1]+j>>>0,t[2]=t[2]+A>>>0,t[3]=t[3]+P>>>0,t[4]=t[4]+k>>>0}return Uint8Array.of(t[0]>>24,t[0]>>16,t[0]>>8,t[0],t[1]>>24,t[1]>>16,t[1]>>8,t[1],t[2]>>24,t[2]>>16,t[2]>>8,t[2],t[3]>>24,t[3]>>16,t[3]>>8,t[3],t[4]>>24,t[4]>>16,t[4]>>8,t[4])}var ue=De;function q(r,e,t,i){return W(80,ue,r,e,t,i)}q.DNS=fe;q.URL=de;var Oe=q;var b=class{constructor(e=U(),t="John Doe"){this.id=e;this.name=t}created=new Date().toISOString();lastVisit=new Date().toISOString();organizations=[]},pe=class{constructor(e=U(),t="ABC"){this.id=e;this.name=t;this.alternativeIDs=[e]}created=new Date().toISOString();admins=[];members=[];alternativeIDs=[]},le=class{constructor(e,t=U(),i="ABC"){this.organizationID=e;this.id=t;this.name=i;this.alternativeIDs=[t]}created=new Date().toISOString();lastSync=null;isPublic=!1;members=[];syncers=[];admins=[];alternativeIDs=[];syncDetails={}};var R=class{auth=new B;menuAlwaysVisible=!1;menuOptions=["ASSISTANT","SYNC_OVERVIEW","SIGN_OUT"];hostApp="SharePoint";config},B=class{providers=["microsoft.com"];persistence="LOCAL"};var O=class r{_collection;constructor(){let e=D(_());this._collection=y(e,"users")}async createUserIfNotExists(e){let t=h(this._collection,e.id);try{if((await I(t)).exists())return;await S(t,m({},e))}catch(i){console.warn(i)}}async getUserData(e,t=!0){let i=h(this._collection,e),n=(await I(i)).data();return t&&n!==void 0&&this._setLastVisit(n),n}async _setLastVisit(e){let t=h(this._collection,e.id);e.lastVisit=new Date().toISOString(),await S(t,m({},e)),console.info("Last visit updated")}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var w=class r{_userRepo=g(O);_auth;_persistence="NONE";_user=p(void 0);_selectedProvider=p(void 0);constructor(){this._auth=ie(_()),this._auth.onAuthStateChanged(e=>{e?this._user.update(()=>Object.assign({},e)):this._user.update(()=>{})})}get user(){return this._user}async setPersistence(e){if(this._persistence!==e){switch(this._persistence=e,e){case"LOCAL":await this._auth.setPersistence(ee);break;case"SESSION":await this._auth.setPersistence(te);break;case"NONE":await this._auth.setPersistence(F);break;default:await this._auth.setPersistence(F)}console.info(`New persistence setting: ${e}`)}}set providers(e){if(e.length===1){let t=e[0];t!=="USER_PW"&&t!=="NO_AUTH"&&this._selectedProvider.set(e[0])}}set selectedProvider(e){this._selectedProvider.set(e),this._user()===void 0&&this.getUserOrRequestSignIn()}async signOut(){await X(this._auth)}async getUserOrRequestSignIn(){let e=this._auth.currentUser,t=this._selectedProvider();if(console.info(`Signed in as ${e?.displayName}`),!e)if(t!==void 0){let i=new $(t);e=(await re(this._auth,i)).user,this._createUserIfNotExists(e.uid,e.displayName??"Anonymous")}else console.info("'Your setup requires input from the user either because one than one SSO provider is set or because user/pw is required. User input is therefore needed'");return e}async userPWSignIn(e,t){return(await K(this._auth,e,t)).user}async _createUserIfNotExists(e,t){let i=new b(e,t);await this._userRepo.createUserIfNotExists(i)}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var T=class r{_collection;constructor(){let e=D(_());this._collection=y(e,"projects")}async getProjectData(e){let t=h(this._collection,e);try{return(await I(t)).data()}catch(i){console.warn(i);return}}async createProjectIfNotExists(e){let t=h(this._collection,e.id);try{await S(t,m({},e))}catch(i){console.warn(i)}}async setFileLastSync(e,t){console.log("SET LAST SYNC");let i=h(this._collection,e),o=new Date().toISOString();try{let a=(await I(i)).data();a.syncDetails===void 0&&(a.syncDetails={}),a.lastSync=new Date().toISOString(),a.syncDetails[t]=o,await S(i,m({},a))}catch(n){console.warn(n)}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var C=class r{_repo=g(T);_projectId=p(void 0);_projectData=p(void 0);hostInfo=p(void 0);constructor(){}set projectId(e){e!==this._projectId()&&(this._projectId.set(e),this._fetchProjectData())}get projectData(){return this._projectData}async createProject(e){await this._repo.createProjectIfNotExists(e),await this._fetchProjectData()}async _fetchProjectData(){let e=this._projectId();if(e===void 0)throw new Error("Project not set");let t=await this._repo.getProjectData(e);t===void 0?this._projectData.set(null):this._projectData.update(()=>Object.assign({},t))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var z=class r{_collection;constructor(){let e=D(_());this._collection=y(e,"organizations")}async getUserOrganizations(e){try{let t=[];for(let i of e){let n=(await se(oe(this._collection,ne("members","array-contains",i)))).docs.map(a=>a.data());if(n.length){t=n;break}}return t}catch(t){return console.warn(t),[]}}async createOrganizationIfNotExists(e){let t=h(this._collection,e.id);try{if((await I(t)).exists())return;let o=await S(t,m({},e));console.log(o)}catch(i){console.warn(i)}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var L=class r{_repo=g(O);_auth=g(w);_organizationRepo=g(z);organizations=p(void 0);_userData=p(void 0);isOrgAdmin=p(!1);_userIds=p([]);onUserChange=N(async()=>{if(this._auth.user()===void 0){this.organizations.update(()=>[]);return}this.fetchUserOrganizations(),this._fetchUserData()});constructor(){}get userIds(){return this._userIds}async createUser(e){this._repo.createUserIfNotExists(e)}async fetchUserOrganizations(){let e=this._auth.user();if(e===void 0)throw new Error("Can't fetch organizations when user is not signed in");let t=e.providerData.map(n=>n.uid),i=[e.uid,...t];if(e===void 0)throw new Error("User not set");let o=await this._organizationRepo.getUserOrganizations(i);this._userIds.set(i),this.organizations.update(()=>[...o])}async _fetchUserData(){let e=this._auth.user();if(e===void 0)throw new Error("Can't fetch user data when user is not signed in");let t=await this._repo.getUserData(e.uid);this._userData.update(()=>Object.assign({},t))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var V=class r{options=p(new R);static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var ge=class r{_optionsService=g(V);_auth=g(w);_user=g(L);_project=g(C);view=p("sync");_selectedOrganization=Z(()=>{let e=this._user.organizations();if(!(e===void 0||!e.length)&&e.length===1)return e[0]});_userIsOrgAdmin=x(()=>{let e=this._selectedOrganization();return e===void 0?!1:this._isCurrentUserOrgAdmin(e)});_userCanSync=x(()=>{let e=this._project.projectData();return!e||e===void 0?!1:this._isCurrentUserSyncer(e)});authDisabled=x(()=>this._optionsService.options().auth.providers.length===1&&this._optionsService.options().auth.providers[0]==="NO_AUTH");x=N(()=>this._userCanSync());userOrganizations=this._user.organizations;projectData=this._project.projectData;projectExists=x(()=>this.projectData()!==null);userHasOrgs=x(()=>{let e=this.userOrganizations();return!(e===void 0||e.length===0)});constructor(){}set options(e){this._optionsService.options.set(e),this._auth.providers=e.auth.providers,this._auth.setPersistence(e.auth.persistence).then(()=>{this._auth.getUserOrRequestSignIn()}).catch(t=>{console.error(t)})}get options(){return this._optionsService.options}get user(){return this._auth.user}set projectId(e){this._project.projectId=e}get selectedOrganization(){return this._selectedOrganization}set selectedOrganization(e){this._selectedOrganization.set(e)}get userIsOrgAdmin(){return this._userIsOrgAdmin}get userCanSync(){return this._userCanSync}_isCurrentUserOrgAdmin(e){let t=this._user.userIds(),i=!1;for(let o of t)if(e.admins.includes(o)){i=!0;break}return i}_isCurrentUserSyncer(e){let t=this._user.userIds(),i=!1;for(let o of t)if(e.syncers.includes(o)||e.admins.includes(o)){i=!0;break}return i}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};export{Oe as a,pe as b,le as c,R as d,w as e,T as f,C as g,z as h,L as i,V as j,ge as k};
