import{Da as re,N as $,ea as K,ja as X,ka as ee,l as k,sa as te,v as Z}from"./chunk-YQ7LY5XH.js";import{C as O,Ca as y,W as ie,Y as oe,t as v,v as m,wa as x,za as ne}from"./chunk-3CERLCYU.js";import{O as h}from"./chunk-6QX3GPPT.js";import{Q as u,U as l,Va as d,ec as S,fc as J,hc as P}from"./chunk-Q5IV2UU5.js";import{a as I}from"./chunk-DAQOROHW.js";var se=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function he(r){return typeof r=="string"&&se.test(r)}var ae=he;function me(r){if(!ae(r))throw TypeError("Invalid UUID");let e;return Uint8Array.of((e=parseInt(r.slice(0,8),16))>>>24,e>>>16&255,e>>>8&255,e&255,(e=parseInt(r.slice(9,13),16))>>>8,e&255,(e=parseInt(r.slice(14,18),16))>>>8,e&255,(e=parseInt(r.slice(19,23),16))>>>8,e&255,(e=parseInt(r.slice(24,36),16))/1099511627776&255,e/4294967296&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255)}var F=me;var f=[];for(let r=0;r<256;++r)f.push((r+256).toString(16).slice(1));function b(r,e=0){return(f[r[e+0]]+f[r[e+1]]+f[r[e+2]]+f[r[e+3]]+"-"+f[r[e+4]]+f[r[e+5]]+"-"+f[r[e+6]]+f[r[e+7]]+"-"+f[r[e+8]]+f[r[e+9]]+"-"+f[r[e+10]]+f[r[e+11]]+f[r[e+12]]+f[r[e+13]]+f[r[e+14]]+f[r[e+15]]).toLowerCase()}var H,_e=new Uint8Array(16);function M(){if(!H){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");H=crypto.getRandomValues.bind(crypto)}return H(_e)}function Ie(r){r=unescape(encodeURIComponent(r));let e=new Uint8Array(r.length);for(let t=0;t<r.length;++t)e[t]=r.charCodeAt(t);return e}var ce="6ba7b810-9dad-11d1-80b4-00c04fd430c8",fe="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function W(r,e,t,i,o,s){let g=typeof t=="string"?Ie(t):t,p=typeof i=="string"?F(i):i;if(typeof i=="string"&&(i=F(i)),i?.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let n=new Uint8Array(16+g.length);if(n.set(p),n.set(g,p.length),n=e(n),n[6]=n[6]&15|r,n[8]=n[8]&63|128,o){s=s||0;for(let a=0;a<16;++a)o[s+a]=n[a];return o}return b(n)}var Se=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Y={randomUUID:Se};function ve(r,e,t){if(Y.randomUUID&&!e&&!r)return Y.randomUUID();r=r||{};let i=r.random||(r.rng||M)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let o=0;o<16;++o)e[t+o]=i[o];return e}return b(i)}var E=ve;function Oe(r,e,t,i){switch(r){case 0:return e&t^~e&i;case 1:return e^t^i;case 2:return e&t^e&i^t&i;case 3:return e^t^i}}function G(r,e){return r<<e|r>>>32-e}function xe(r){let e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520],i=new Uint8Array(r.length+1);i.set(r),i[r.length]=128,r=i;let o=r.length/4+2,s=Math.ceil(o/16),g=new Array(s);for(let p=0;p<s;++p){let n=new Uint32Array(16);for(let a=0;a<16;++a)n[a]=r[p*64+a*4]<<24|r[p*64+a*4+1]<<16|r[p*64+a*4+2]<<8|r[p*64+a*4+3];g[p]=n}g[s-1][14]=(r.length-1)*8/Math.pow(2,32),g[s-1][14]=Math.floor(g[s-1][14]),g[s-1][15]=(r.length-1)*8&4294967295;for(let p=0;p<s;++p){let n=new Uint32Array(80);for(let c=0;c<16;++c)n[c]=g[p][c];for(let c=16;c<80;++c)n[c]=G(n[c-3]^n[c-8]^n[c-14]^n[c-16],1);let a=t[0],U=t[1],j=t[2],A=t[3],V=t[4];for(let c=0;c<80;++c){let B=Math.floor(c/20),ge=G(a,5)+Oe(B,U,j,A)+V+e[B]+n[c]>>>0;V=A,A=j,j=G(U,30)>>>0,U=a,a=ge}t[0]=t[0]+a>>>0,t[1]=t[1]+U>>>0,t[2]=t[2]+j>>>0,t[3]=t[3]+A>>>0,t[4]=t[4]+V>>>0}return Uint8Array.of(t[0]>>24,t[0]>>16,t[0]>>8,t[0],t[1]>>24,t[1]>>16,t[1]>>8,t[1],t[2]>>24,t[2]>>16,t[2]>>8,t[2],t[3]>>24,t[3]>>16,t[3]>>8,t[3],t[4]>>24,t[4]>>16,t[4]>>8,t[4])}var ue=xe;function Q(r,e,t,i){return W(80,ue,r,e,t,i)}Q.DNS=ce;Q.URL=fe;var ye=Q;var de=class{constructor(e=E(),t="ABC"){this.id=e;this.name=t;this.alternativeIDs=[e]}created=new Date().toISOString();admins=[];members=[];alternativeIDs=[]},pe=class{constructor(e,t=E(),i="ABC"){this.organizationID=e;this.id=t;this.name=i;this.alternativeIDs=[t]}created=new Date().toISOString();lastSync=null;isPublic=!1;members=[];syncers=[];admins=[];alternativeIDs=[];syncDetails={}};var N=class{auth=new q;menuAlwaysVisible=!1;menuOptions=["ASSISTANT","SYNC_OVERVIEW","SIGN_OUT"];hostApp="SharePoint";config},q=class{providers=["microsoft.com"];persistence="LOCAL"};var D=class r{_collection;constructor(){let e=O(h());this._collection=v(e,"users")}async getUserData(e,t=!0){let i=m(this._collection,e),s=(await x(i)).data();return t&&s!==void 0&&this._setLastVisit(s),s}async _setLastVisit(e){let t=m(this._collection,e.id);e.lastVisit=new Date().toISOString(),await y(t,I({},e)),console.info("Last visit updated")}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var w=class r{_userRepo=l(D);_auth;_persistence="NONE";_user=d(void 0);_selectedProvider=d(void 0);constructor(){this._auth=re(h()),this._auth.onAuthStateChanged(e=>{e?this._user.update(()=>Object.assign({},e)):this._user.update(()=>{})})}get user(){return this._user}async setPersistence(e){if(this._persistence!==e){switch(this._persistence=e,e){case"LOCAL":await this._auth.setPersistence(X);break;case"SESSION":await this._auth.setPersistence(ee);break;case"NONE":await this._auth.setPersistence(k);break;default:await this._auth.setPersistence(k)}console.info(`New persistence setting: ${e}`)}}set providers(e){if(e.length===1){let t=e[0];t!=="USER_PW"&&t!=="NO_AUTH"&&this._selectedProvider.set(e[0])}}set selectedProvider(e){this._selectedProvider.set(e),this._user()===void 0&&this.getUserOrRequestSignIn()}async signOut(){await K(this._auth)}async getUserOrRequestSignIn(){let e=this._auth.currentUser,t=this._selectedProvider();if(console.info(`Signed in as ${e?.displayName}`),!e)if(t!==void 0){let i=new Z(t);e=(await te(this._auth,i)).user}else console.info("'Your setup requires input from the user either because one than one SSO provider is set or because user/pw is required. User input is therefore needed'");return e}async userPWSignIn(e,t){return(await $(this._auth,e,t)).user}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var R=class r{_collection;constructor(){let e=O(h());this._collection=v(e,"projects")}async getProjectData(e){let t=m(this._collection,e);try{return(await x(t)).data()}catch(i){console.warn(i);return}}async createProjectIfNotExists(e){let t=m(this._collection,e.id);try{await y(t,I({},e))}catch(i){console.warn(i)}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var T=class r{_repo=l(R);_projectId=d(void 0);_projectData=d(void 0);hostInfo=d(void 0);constructor(){}set projectId(e){e!==this._projectId()&&(this._projectId.set(e),this._fetchProjectData())}get projectData(){return this._projectData}async createProject(e){await this._repo.createProjectIfNotExists(e),await this._fetchProjectData()}async _fetchProjectData(){let e=this._projectId();if(e===void 0)throw new Error("Project not set");let t=await this._repo.getProjectData(e);t===void 0?this._projectData.set(null):this._projectData.update(()=>Object.assign({},t))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var C=class r{_collection;constructor(){let e=O(h());this._collection=v(e,"organizations")}async getUserOrganizations(e){try{let t=[];for(let i of e){let s=(await ne(ie(this._collection,oe("members","array-contains",i)))).docs.map(g=>g.data());if(s.length){t=s;break}}return t}catch(t){return console.warn(t),[]}}async createOrganizationIfNotExists(e){let t=m(this._collection,e.id);try{if((await x(t)).exists())return;let o=await y(t,I({},e));console.log(o)}catch(i){console.warn(i)}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var z=class r{_repo=l(D);_auth=l(w);_organizationRepo=l(C);organizations=d(void 0);_userData=d(void 0);isOrgAdmin=d(!1);_userIds=d([]);onUserChange=P(async()=>{if(this._auth.user()===void 0){this.organizations.update(()=>[]);return}this.fetchUserOrganizations(),this._fetchUserData()});constructor(){}get userIds(){return this._userIds}async fetchUserOrganizations(){let e=this._auth.user();if(e===void 0)throw new Error("Can't fetch organizations when user is not signed in");let t=e.providerData.map(s=>s.uid),i=[e.uid,...t];if(e===void 0)throw new Error("User not set");let o=await this._organizationRepo.getUserOrganizations(i);this._userIds.set(i),this.organizations.update(()=>[...o])}async _fetchUserData(){let e=this._auth.user();if(e===void 0)throw new Error("Can't fetch user data when user is not signed in");let t=await this._repo.getUserData(e.uid);this._userData.update(()=>Object.assign({},t))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var L=class r{options=d(new N);static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};var le=class r{_optionsService=l(L);_auth=l(w);_user=l(z);_project=l(T);view=d("sync");_selectedOrganization=J(()=>{let e=this._user.organizations();if(!(e===void 0||!e.length)&&e.length===1)return e[0]});_userIsOrgAdmin=S(()=>{let e=this._selectedOrganization();return e===void 0?!1:this._isCurrentUserOrgAdmin(e)});_userCanSync=S(()=>{let e=this._project.projectData();return!e||e===void 0?!1:this._isCurrentUserSyncer(e)});authDisabled=S(()=>this._optionsService.options().auth.providers.length===1&&this._optionsService.options().auth.providers[0]==="NO_AUTH");x=P(()=>this._userCanSync());userOrganizations=this._user.organizations;projectData=this._project.projectData;projectExists=S(()=>this.projectData()!==null);userHasOrgs=S(()=>{let e=this.userOrganizations();return!(e===void 0||e.length===0)});constructor(){}set options(e){this._optionsService.options.set(e),this._auth.providers=e.auth.providers,this._auth.setPersistence(e.auth.persistence).then(()=>{this._auth.getUserOrRequestSignIn()}).catch(t=>{console.error(t)})}get options(){return this._optionsService.options}get user(){return this._auth.user}set projectId(e){this._project.projectId=e}get selectedOrganization(){return this._selectedOrganization}set selectedOrganization(e){this._selectedOrganization.set(e)}get userIsOrgAdmin(){return this._userIsOrgAdmin}get userCanSync(){return this._userCanSync}_isCurrentUserOrgAdmin(e){let t=this._user.userIds(),i=!1;for(let o of t)if(e.admins.includes(o)){i=!0;break}return i}_isCurrentUserSyncer(e){let t=this._user.userIds(),i=!1;for(let o of t)if(e.syncers.includes(o)||e.admins.includes(o)){i=!0;break}return i}static \u0275fac=function(t){return new(t||r)};static \u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})};export{ye as a,de as b,pe as c,N as d,w as e,T as f,C as g,z as h,L as i,le as j};
